<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Timeline Vault Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        .hidden-options .btn-opt { display: none !important; }
        .hidden-options .keep-visible { display: flex !important; }
        .image-container img { width: 100%; display: block; background: #f0f0f0; transition: all 0.3s ease; }
        .img-wrapped { height: 200px !important; object-fit: cover; }
        .img-unwrapped { height: auto !important; object-fit: contain; }
        .auto-expand { overflow: hidden; min-height: 80px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* Dragging Styles */
        .sortable-ghost { opacity: 0.3; background: #ebf5ff; border: 2px dashed #3b82f6; }
        .drag-handle { cursor: grab; }
        .drag-handle:active { cursor: grabbing; }

        @keyframes copySuccess {
            0% { background-color: transparent; }
            50% { background-color: #dcfce7; }
            100% { background-color: transparent; }
        }
        .copy-flash { animation: copySuccess 0.6s ease-in-out; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen pb-10">

    <div id="dashboard" class="max-w-2xl mx-auto p-4">
        <div class="flex justify-between items-center mb-6 mt-4">
            <h1 class="text-2xl font-black text-gray-800 tracking-tight">Timeline Vault</h1>
            <div class="flex gap-2">
                <button onclick="exportAllData()" class="bg-green-600 text-white px-3 py-2 rounded-lg text-xs font-bold uppercase shadow-sm">Backup All</button>
                <button onclick="triggerRestore()" class="bg-blue-600 text-white px-3 py-2 rounded-lg text-xs font-bold uppercase shadow-sm">Restore All</button>
            </div>
        </div>
        <div class="mb-6">
            <input type="text" id="projectSearch" oninput="renderProjects()" placeholder="Search timelines..." 
                class="w-full p-3 rounded-xl border border-gray-300 shadow-sm outline-none focus:ring-2 focus:ring-blue-400">
        </div>
        <div id="projectList" class="grid gap-4"></div>
        <button onclick="createNewProject()" class="w-full mt-8 border-2 border-dashed border-gray-400 p-8 rounded-2xl text-gray-500 font-bold hover:bg-gray-50 transition-colors">
            + Create New Timeline
        </button>
    </div>

    <div id="editor" class="hidden">
        <header class="sticky top-0 bg-white shadow-sm border-b p-3 z-30">
            <div class="max-w-2xl mx-auto flex flex-col gap-3">
                <div class="flex items-center gap-2">
                    <button onclick="showDashboard()" class="text-blue-600 font-bold pr-2 border-r border-gray-200">← Back</button>
                    <input id="projectTitleInput" type="text" class="bg-transparent p-1 text-xl font-bold focus:outline-none flex-grow text-gray-800">
                </div>
                <div class="flex gap-2 overflow-x-auto no-scrollbar">
                    <button onclick="toggleOptions()" id="toggleBtn" class="whitespace-nowrap bg-gray-800 text-white px-4 py-2 rounded-lg text-xs font-bold uppercase">Show Options</button>
                    <button onclick="toggleWrap()" id="wrapBtn" class="whitespace-nowrap text-white px-4 py-2 rounded-lg text-xs font-bold uppercase">Wrap Content</button>
                    <button onclick="deleteCurrentProject()" class="whitespace-nowrap bg-red-50 text-red-600 px-4 py-2 rounded-lg text-xs font-bold uppercase">Delete</button>
                </div>
            </div>
        </header>
        <main class="max-w-2xl mx-auto mt-4 px-3" id="cardContainer"></main>
    </div>

    <input type="file" id="restoreFile" class="hidden" accept=".json" onchange="importAllData(event)">

    <script>
        const db = new Dexie("MultiTimelineDB");
        db.version(3).stores({
            projects: '++id, title, lastModified, isWrapped',
            cards: '++id, projectId, text, image, sortOrder'
        });

        let currentProjectId = null;
        let showAllButtons = false;
        let sortableInstance = null;

        async function init() { renderProjects(); }

        // --- DASHBOARD ---
        async function renderProjects() {
            const query = document.getElementById('projectSearch').value.toLowerCase();
            const projects = await db.projects.orderBy('lastModified').reverse().toArray();
            const filtered = projects.filter(p => p.title.toLowerCase().includes(query));
            const list = document.getElementById('projectList');
            list.innerHTML = '';
            filtered.forEach(p => {
                const item = document.createElement('div');
                item.className = "bg-white p-5 rounded-2xl shadow-sm border border-gray-200 flex justify-between items-center cursor-pointer hover:shadow-md transition active:scale-[0.98]";
                item.onclick = () => openProject(p.id);
                item.innerHTML = `<div><h3 class="font-bold text-lg text-gray-800">${p.title || 'Untitled'}</h3><p class="text-xs text-gray-400">Modified: ${new Date(p.lastModified).toLocaleDateString()}</p></div><span class="text-blue-500 font-bold">Open →</span>`;
                list.appendChild(item);
            });
        }

        async function createNewProject() {
            const id = await db.projects.add({ title: "New Timeline", lastModified: Date.now(), isWrapped: false });
            openProject(id);
        }

        async function openProject(id) {
            currentProjectId = id;
            const project = await db.projects.get(id);
            document.getElementById('projectTitleInput').value = project.title;
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('editor').classList.remove('hidden');
            showAllButtons = false;
            updateWrapButtonUI(project.isWrapped);
            renderCards();
        }

        function showDashboard() {
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('editor').classList.add('hidden');
            renderProjects();
        }

        // --- CARDS ---
        async function addNewCard(targetSortOrder = null) {
            const allCards = await db.cards.where('projectId').equals(currentProjectId).sortBy('sortOrder');
            let newSortOrder;

            if (allCards.length === 0) {
                newSortOrder = 1000000;
            } else if (targetSortOrder === null) {
                newSortOrder = allCards[allCards.length - 1].sortOrder + 1000000;
            } else {
                const index = allCards.findIndex(c => c.sortOrder === targetSortOrder);
                const nextCard = allCards[index + 1];
                newSortOrder = nextCard ? (targetSortOrder + nextCard.sortOrder) / 2 : targetSortOrder + 1000000;
            }

            await db.cards.add({ projectId: currentProjectId, text: "", image: null, sortOrder: newSortOrder });
            await db.projects.update(currentProjectId, { lastModified: Date.now() });
            renderCards();
        }

        async function renderCards() {
            const project = await db.projects.get(currentProjectId);
            const cards = await db.cards.where('projectId').equals(currentProjectId).sortBy('sortOrder');
            const container = document.getElementById('cardContainer');
            container.innerHTML = '';
            const imgClass = project.isWrapped ? 'img-wrapped' : 'img-unwrapped';

            if (cards.length === 0) {
                container.innerHTML = `<div class="py-20 text-center"><button onclick="addNewCard()" class="bg-black text-white px-8 py-4 rounded-2xl font-bold tracking-wide uppercase text-sm">+ Start Timeline</button></div>`;
                return;
            }

            cards.forEach(card => {
                const cardWrapper = document.createElement('div');
                cardWrapper.dataset.id = card.id;
                cardWrapper.className = "timeline-item-container mb-2";
                cardWrapper.innerHTML = `
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden ${!showAllButtons ? 'hidden-options' : ''}">
                        <div class="p-2 border-b bg-gray-50 flex justify-between items-center btn-opt">
                            <div class="flex items-center gap-2">
                                <span class="drag-handle text-gray-400">⠿</span>
                                <span class="text-[10px] text-gray-400 italic font-mono">ID: ${card.id}</span>
                            </div>
                            <button onclick="deleteCard(${card.id})" class="text-red-500 text-[10px] font-bold uppercase bg-red-50 px-2 py-1 rounded">Delete</button>
                        </div>
                        <div class="image-container relative">
                            ${card.image ? `<img src="${card.image}" class="${imgClass}" />` : `<div class="h-24 flex items-center justify-center bg-gray-50 text-gray-300 text-xs italic">No image added</div>`}
                            <div class="p-2 flex gap-2 bg-white border-t items-center">
                                <button onclick="triggerUpload(${card.id})" class="flex-grow btn-opt bg-blue-50 text-blue-600 font-bold py-2 rounded text-xs uppercase">Replace / Add</button>
                                ${card.image ? `<button onclick="downloadImage('${card.image}', ${card.id})" class="keep-visible bg-gray-800 text-white px-4 py-2 rounded-lg font-bold shadow-sm text-xs">Download ↓</button>` : ''}
                            </div>
                        </div>
                        <div class="p-4">
                            <textarea id="text-${card.id}" readonly class="auto-expand w-full border-b border-transparent rounded p-1 text-gray-800 outline-none resize-none transition-all block" oninput="autoResize(this)">${card.text || ''}</textarea>
                            <div class="flex gap-2 mt-4">
                                <button onclick="toggleEdit(${card.id})" id="edit-btn-${card.id}" class="flex-grow btn-opt bg-blue-600 text-white font-bold py-3 rounded-lg text-sm shadow-sm">Edit Text</button>
                                <button onclick="copyCurrentText(${card.id})" class="px-6 bg-gray-100 text-gray-700 font-bold py-3 rounded-lg text-sm active:bg-gray-200">Copy</button>
                            </div>
                        </div>
                        <input type="file" id="file-${card.id}" class="hidden" accept="image/*,image/gif" onchange="handleFileUpload(event, ${card.id})">
                    </div>
                    <div class="flex justify-center py-4 add-below-btn">
                        <button onclick="addNewCard(${card.sortOrder})" class="group flex items-center gap-2 text-gray-300 hover:text-blue-500 transition-colors">
                            <div class="h-[1px] w-6 bg-current opacity-20"></div>
                            <span class="text-[10px] font-black uppercase tracking-[0.2em]">+ Add Below</span>
                            <div class="h-[1px] w-6 bg-current opacity-20"></div>
                        </button>
                    </div>
                `;
                container.appendChild(cardWrapper);
                autoResize(document.getElementById(`text-${card.id}`));
            });

            initSortable();
        }

        // --- SORTING LOGIC ---
        function initSortable() {
            const el = document.getElementById('cardContainer');
            if (sortableInstance) sortableInstance.destroy();

            sortableInstance = Sortable.create(el, {
                handle: '.drag-handle', // Restricted to the "⠿" icon
                ghostClass: 'sortable-ghost',
                animation: 200,
                onEnd: async function () {
                    const itemEls = el.querySelectorAll('.timeline-item-container');
                    const updates = [];
                    
                    // Simple re-indexing: assign new sort orders based on current visual sequence
                    for (let i = 0; i < itemEls.length; i++) {
                        const id = parseInt(itemEls[i].dataset.id);
                        updates.push(db.cards.update(id, { sortOrder: (i + 1) * 1000000 }));
                    }

                    await Promise.all(updates);
                    await db.projects.update(currentProjectId, { lastModified: Date.now() });
                    renderCards(); // Re-render to ensure internal logic (like "Add Below") matches visual order
                }
            });
        }

        // --- HELPERS ---
        function autoResize(el) { el.style.height = 'auto'; el.style.height = el.scrollHeight + 'px'; }

        async function toggleWrap() {
            const p = await db.projects.get(currentProjectId);
            const newState = !p.isWrapped;
            await db.projects.update(currentProjectId, { isWrapped: newState });
            updateWrapButtonUI(newState);
            renderCards();
        }

        function updateWrapButtonUI(state) {
            const btn = document.getElementById('wrapBtn');
            btn.innerText = state ? "Unwrap Content" : "Wrap Content";
            btn.className = `whitespace-nowrap ${state ? 'bg-indigo-500' : 'bg-amber-500'} text-white px-4 py-2 rounded-lg text-xs font-bold uppercase`;
        }

        async function toggleEdit(id) {
            const tx = document.getElementById(`text-${id}`);
            const btn = document.getElementById(`edit-btn-${id}`);
            if (tx.hasAttribute('readonly')) {
                tx.removeAttribute('readonly'); tx.classList.add('bg-blue-50', 'border-blue-200'); tx.focus();
                btn.innerText = "Save Changes"; btn.classList.replace('bg-blue-600', 'bg-green-600');
            } else {
                await db.cards.update(id, { text: tx.value });
                tx.setAttribute('readonly', true); tx.classList.remove('bg-blue-50', 'border-blue-200');
                btn.innerText = "Edit Text"; btn.classList.replace('bg-green-600', 'bg-blue-600');
            }
        }

        async function copyCurrentText(id) {
            const tx = document.getElementById(`text-${id}`);
            if(!tx.value) return;
            await navigator.clipboard.writeText(tx.value);
            tx.classList.add('copy-flash');
            setTimeout(() => tx.classList.remove('copy-flash'), 600);
        }

        function triggerUpload(id) { document.getElementById(`file-${id}`).click(); }

        async function handleFileUpload(ev, id) {
            const file = ev.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                await db.cards.update(id, { image: e.target.result });
                renderCards();
            };
            reader.readAsDataURL(file);
        }

        async function deleteCard(id) { if(confirm("Delete this card?")) { await db.cards.delete(id); renderCards(); } }

        async function deleteCurrentProject() {
            if(confirm("Delete entire timeline?")) {
                await db.cards.where('projectId').equals(currentProjectId).delete();
                await db.projects.delete(currentProjectId);
                showDashboard();
            }
        }

        function toggleOptions() { 
            showAllButtons = !showAllButtons; 
            document.getElementById('toggleBtn').innerText = showAllButtons ? "Hide Options" : "Show Options";
            renderCards(); 
        }

        async function exportAllData() {
            const projects = await db.projects.toArray();
            const cards = await db.cards.toArray();
            const blob = new Blob([JSON.stringify({ projects, cards })], { type: 'application/json' });
            const a = Object.assign(document.createElement('a'), { href: URL.createObjectURL(blob), download: `Backup-${Date.now()}.json` });
            a.click();
        }

        function triggerRestore() { document.getElementById('restoreFile').click(); }

        async function importAllData(ev) {
            const file = ev.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                const data = JSON.parse(e.target.result);
                if (confirm("Replace all data?")) {
                    await db.projects.clear(); await db.cards.clear();
                    await db.projects.bulkAdd(data.projects); await db.cards.bulkAdd(data.cards);
                    location.reload();
                }
            };
            reader.readAsText(file);
        }

        function downloadImage(b64, id) {
            const a = Object.assign(document.createElement('a'), { href: b64, download: `img-${id}.png` });
            a.click();
        }

        document.getElementById('projectTitleInput').addEventListener('input', async (e) => {
            await db.projects.update(currentProjectId, { title: e.target.value, lastModified: Date.now() });
        });

        init();
    </script>
</body>
</html>
